name: NPSHARP Build ‚Ä¢ Validate ‚Ä¢ Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.15.1

      ###############################################################
      # üîµ VALIDAR AMBIENTE NO LINUX
      ###############################################################
      - name: Validate Project Structure
        run: |
          echo "üîç CHECKING NODE AND NPM"
          node -v || exit 1
          npm -v || exit 1

          echo "üîç CHECKING package.json"
          if [ ! -f "package.json" ]; then
            echo "‚ùå ERROR: package.json not found!"
            exit 1
          fi
          echo "‚úî Found package.json"

          echo "üîç CHECKING gulpfile.js"
          if [ ! -f "gulpfile.js" ]; then
            echo "‚ùå ERROR: gulpfile.js not found!"
            exit 1
          fi
          echo "‚úî Found gulpfile.js"

      - name: Install Linux Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libnotify-bin \
            pkg-config \
            libsecret-1-dev \
            libkrb5-dev \
            libnss3-dev

      - name: Install Linux Packaging Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            rpm \
            xz-utils \
            p7zip-full \
            graphicsmagick \
            icnsutils \
            libarchive-tools

      - name: Install NPM Dependencies
        run: npm install --legacy-peer-deps

      - name: Validate Gulp + Tasks
        run: |
          npx gulp --version || (echo "‚ùå Gulp not installed!" && exit 1)
          npx gulp --tasks || (echo "‚ùå No Gulp tasks found!" && exit 1)

          echo "üîç Checking npm script 'compile'"
          if ! npm run | grep -q "compile"; then
            echo "‚ùå Missing script 'compile' in package.json"
            exit 1
          fi
          echo "‚úî All validations passed."

      ###############################################################
      # üîµ BUILD LINUX
      ###############################################################
      - name: Compile (Linux)
        run: npm run compile

      - name: Build Linux (Portable)
        run: npx gulp vscode-linux-x64

      - name: Zip Linux Build
        run: |
          cd out
          zip -r linux-build.zip vscode-linux-x64 || true

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: out/linux-build.zip


  ###################################################################
  # WINDOWS BUILD
  ###################################################################
  build-windows:
    name: Build Windows
    runs-on: windows-2022

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.15.1

      ###############################################################
      # üîµ VALIDAR AMBIENTE NO WINDOWS
      ###############################################################
      - name: Validate Project Structure
        run: |
          echo "üîç Checking package.json..."
          if (!(Test-Path "./package.json")) {
            Write-Error "‚ùå package.json not found!"
            exit 1
          }
          echo "‚úî package.json found."

          echo "üîç Checking gulpfile.js..."
          if (!(Test-Path "./gulpfile.js")) {
            Write-Error "‚ùå gulpfile.js not found!"
            exit 1
          }
          echo "‚úî gulpfile.js found."

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Validate Gulp + Tasks
        run: |
          npx gulp --version
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Gulp missing!"
            exit 1
          }

          npx gulp --tasks
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå No gulp tasks found!"
            exit 1
          }

          npm run | findstr compile
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Missing compile script"
            exit 1
          }

      ###############################################################
      # üîµ BUILD WINDOWS
      ###############################################################
      - name: Compile Windows
        run: npm run compile

      - name: Build Portable
        run: npx gulp vscode-win32-x64

      - name: Zip Windows Build
        run: |
          cd out
          powershell Compress-Archive -Path vscode-win32-x64 -DestinationPath windows-build.zip

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: out/windows-build.zip


  ###################################################################
  # RELEASE FINAL
  ###################################################################
  release:
    name: Release All Artifacts
    runs-on: ubuntu-22.04
    needs: [build-linux, build-windows]

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "NPSharp Build ${{ github.run_number }}"
          files: |
            release/**/linux-build.zip
            release/**/windows-build.zip
