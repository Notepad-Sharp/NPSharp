name: NPSHARP Build & Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_QUALITY: 'oss'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  compile:
    name: Compile & Prepare
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential pkg-config libx11-dev libxkbfile-dev libnotify-bin libkrb5-dev
          npm ci

      - name: Compile NPSHARP
        run: npm exec -- npm-run-all -lp core-ci extensions-ci hygiene

      - name: Save artifacts for other jobs
        uses: actions/upload-artifact@v5
        with:
          name: npsharp-build
          path: |
            .build
            node_modules

  linux-build:
    name: Linux Build
    needs: compile
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: npsharp-build
          path: .

      - name: Build Linux Portables & Installer
        run: npm run gulp npsharp-linux

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: linux-artifacts
          path: ./out

  windows-build:
    name: Windows Build
    needs: compile
    runs-on: windows-2022
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: npsharp-build
          path: .

      - name: Build Windows Portables & Installer
        run: npm run gulp npsharp-win32

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: windows-artifacts
          path: ./out

  macos-build:
    name: macOS Build
    needs: compile
    runs-on: macos-14
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: npsharp-build
          path: .

      - name: Build macOS Portables & Installer
        run: npm run gulp npsharp-darwin

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: macos-artifacts
          path: ./out

  create-release:
    name: Create Tag & Release
    needs: [linux-build, windows-build, macos-build]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set Tag
        id: tag
        run: |
          TAG="v$(date +'%Y.%m.%d.%H%M')"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag $TAG
          git push origin $TAG

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG }}
          name: "NPSHARP ${{ env.TAG }}"
          body: "Automated build release"
          draft: false
          prerelease: false

      - name: Upload Linux Artifacts
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url || '' }}
          asset_path: ./out/linux/*.tar.gz
          asset_name: npsharp-linux.tar.gz
          asset_content_type: application/gzip

      - uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url || '' }}
          asset_path: ./out/windows/*.zip
          asset_name: npsharp-win32.zip
          asset_content_type: application/zip

      - uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url || '' }}
          asset_path: ./out/macos/*.zip
          asset_name: npsharp-darwin.zip
          asset_content_type: application/zip
