name: Build NPSharp

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 22

    - name: Cache node_modules
      uses: actions/cache@v3
      with:
        path: node_modules
        key: node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-modules-

    - name: Install dependencies
      run: npm ci

    # Cache para extens√µes VSIX
    - name: Cache VSIX extensions
      uses: actions/cache@v3
      with:
        path: |
          .vscode/extensions
          build/.vsix-cache
        key: vscode-extensions-${{ hashFiles('extensions/**') }}
        restore-keys: |
          vscode-extensions-

    - name: Compile NPSharp
      run: node --max-old-space-size=10240 ./node_modules/gulp/bin/gulp.js compile-build-with-mangling

    - name: Build Extensions with Retry
      shell: pwsh
      run: |
        $RETRIES = 5
        for ($i = 1; $i -le $RETRIES; $i++) {
            Write-Host "Attempt $i..."
            try {
                node --max-old-space-size=10240 ./node_modules/gulp/bin/gulp.js compile-extensions-build --skipLibCheck
                Write-Host "Success on attempt $i"
                break
            } catch {
                Write-Host "Attempt $i failed, retrying in 5 seconds..."
                Start-Sleep -Seconds 5
                if ($i -eq $RETRIES) {
                    throw "All $RETRIES attempts failed."
                }
            }
        }

    - name: Create Portable
      run: node --max-old-space-size=10240 ./node_modules/gulp/bin/gulp.js minify-vscode

    - name: Create Installer
      run: node --max-old-space-size=10240 ./node_modules/gulp/bin/gulp.js 7z # ajuste se tiver script real do installer

    - name: Upload Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NPSharp-Portable
        path: build/output/portable/**/*

    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NPSharp-Installer
        path: build/output/installer/**/*.exe
